<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üçÉBuild your Leaf</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>

<script>

    // TODO: add pictures of cars
    // TODO: sensible defaults for the manual input fields
    // TODO: Sanity check on user input:
    // - Only allow to sell original battery if the main battery was upgraded
    // - Only allow to upgrade to a higher capacity

    /*
    Store configurator options in an JS-Object.

    These values should be made available for an admin through a UI and should be set by a server-side
    script language as a JS-literal.
    */

    var configs = {
        'Car model': {
            '2011':     {'price':[7250, 10500] , 'capacity': 21.3, 'consumption': 175, 'fullspeed': 25, 'soh': [0.7,0.75]},
            '2013':     {'price':[9900, 14500] , 'capacity': 21.3, 'consumption': 169, 'fullspeed': 25, 'soh': [0.77,0.87]},
            '30 kWh':   {'price':[14900, 18000], 'capacity': 28.3, 'consumption': 169, 'fullspeed': 90, 'soh': [0.82,0.88]},
            '40 Kwh':   {'price':[28500, 33250], 'capacity': 38.0, 'consumption': 164, 'fullspeed': 65, 'soh': [0.92,0.96]},
            '62 kWh':   {'price':[49000, 49000], 'capacity': 59.5, 'consumption': 170, 'fullspeed': 45, 'soh': [1,1]}
        },
        'Extender battery': {
            'None':     {'price': 0,   'capacity':0     },
            '8.8 kWh':  {'price':3990, 'capacity':8.8   },
            '17.6 kWh': {'price':5990, 'capacity':17.6  }
        },
        'Main battery upgrade': {
            'None':      {'price': 0,       'capacity': 0 },
            'to 30 kWh': {'price': 6750,    'capacity': 30, 'fullspeed': 90 },
            'to 40 kWh': {'price': 8500,    'capacity': 40, 'fullspeed': 65 },
            'to 62 kWh': {'price': 10500,   'capacity': 62, 'fullspeed': 45 }
        },
        'Sell original battery': {
            'No':null,
            'Automatic': null,
            'Manual input': { unit: "‚Ç¨", min:0, max:10000, step: 50 }
        },
        'Original battery SOH': {
            'Automatic': null,
            'Manual input': {unit: "%", value: 0.75, min:0, max:100, step: 0.5}
        },
        'Include car value': {
            'No': null,
            'Automatic': null,
            'Manual input': {unit: "‚Ç¨", min:0, max:10000, step: 50}
        }
    };

    var soh_default_value = 0.75;

    // Variable initiations;
    var selected_car = null;
    var selected_extender = null;
    var selected_main = null;

    var selected_orig_batt = null;
    var sell_battery_cost = null;
    var manual_sell_orig_batt = null;
    var manual_soh = null;

    var selected_value_cost = null;     // todo: implement calculation
    var selected_soh = null;
    var selected_car_value = null;      // todo: implement calculation

    var usable_capacity = null;
    var range = null;
    var fullspeed_estimate = null;

    var soh_value = null;

</script>


<form id="build-form"></form>
<div id="stats" class="stats">
    <dl><dt>Usable capacity</dt>        <dd id="stats_capacity"></dd> </dl>
    <dl><dt>Range estimate</dt>         <dd id="stats_range"></dd> </dl>
    <dl><dt>Cost of upgrades</dt>       <dd id="stats_cost"></dd> </dl>
    <dl><dt>Full speed charging</dt>    <dd id="stats_chargingspeed"></dd> </dl>
</div>

<div id="svgContainer">
    <!-- This is an HTML div, and inside goes the SVG -->
</div>

<script>
    var form_Configurator = id("build-form");

    loadPictures();
    create_configurator();
    formChanged();

    /**
     *  Load images of cars into our configurator
     */
    function loadPictures(){
        target = document.getElementById("svgContainer");
        loadSVG(target,"2011");
        loadSVG(target,"2013");
        // (...)
    }

    /**
     * Creates all the DOM elements for the configurator tool based on the "configs" array
     */
    function create_configurator(){
        // Iterate over the options array and add buttons for every option

        for(var caption in configs){
            addRow(caption, configs[caption]);
        }

        function addRow(caption, options){
            var elem_categoryName = addElement(form_Configurator,"span",{'class': "caption"});
            setText(elem_categoryName, caption);

            var newRow = addElement(id("build-form"),"div",{'class':"options"});

            var index = 0;
            for(var option in options){
                if( !options.hasOwnProperty(option)) continue;
                addRadioLabel(newRow,option,index++,strToAttribute(caption));
                if(option === "Manual input"){
                    var attributes = options[option];
                    addTextfield(newRow,strToAttribute(caption) + "-manual",attributes);
                }
            }
        }

        function addRadioLabel(target,value,index,name){
            var elem_radio = addElement(target,"input",{
                name: name,
                type: "radio",
                value: value,
                id: name + "-" + index,
            });

            if (index === 0 ) elem_radio.checked = true;

            var label = addElement(target, "label",{
                'for': name + "-" +index
            });

            setText(label,value);
        }

        function addTextfield(target,name,attributes){
            var elem_radio = addElement(target,"input",{
                name: name,
                type: "number",
                value: "0",
                id: name,
                class: "number"
            });

            for(var attribute in attributes){
                elem_radio.setAttribute(attribute, attributes[attribute]);
            }

            setText(addElement(target,"span",{class: 'suffix'}),attributes['unit']);
        }
    }

    // Handle form changes
    form_Configurator.addEventListener("change",formChanged,false);

    function formChanged() {
        readFormValues();
        calculate_stats();
        updateStats();
        updateCar();
    }

    function readFormValues() {
        var form = document.forms['build-form'];

        selected_car      = form['car-model'].value;
        selected_extender = form['extender-battery'].value;
        selected_main     = form['main-battery-upgrade'].value;

        selected_orig_batt    = form['sell-original-battery'].value;
        manual_sell_orig_batt = form['sell-original-battery-manual'].value;

        selected_soh = form['original-battery-soh'].value;
        manual_soh = form['original-battery-soh-manual'].value / 100;

        selected_car_value = form['include-car-value'].value;
    }

    function calculate_stats(){
        // SOH (Status of Health)
        if (selected_soh === "Automatic") soh_value = soh_default_value;
        if (selected_soh === "Manual input") soh_value = manual_soh;

        // usable capacity
        usable_capacity =
            configs['Car model'][selected_car].capacity*soh_value
            + configs['Extender battery'][selected_extender].capacity
            + configs['Main battery upgrade'][selected_main].capacity;

        // range estimate
        range = usable_capacity * 1000 / configs['Car model'][selected_car].consumption;

        // sell original battery
        switch(selected_orig_batt){
            case "No":
                sell_battery_cost = 0;
                break;

            case "Automatic":
                sell_battery_cost = configs['Car model'][selected_car].capacity*soh_value * 150;
                sell_battery_cost = Math.round(sell_battery_cost);
                break;

            case "Manual input":
                sell_battery_cost = manual_sell_orig_batt ;
                break;
        }

        //upgrade cost estimate
        cost =
            configs['Extender battery'][selected_extender].price
            + configs['Main battery upgrade'][selected_main].price
            - sell_battery_cost
            + selected_value_cost;

        // estimate of full-speed charging
        impact_of_extender = configs['Extender battery'][selected_extender].capacity / (usable_capacity);

        // fullspeed estimate
        if (selected_main === "None") {
            if (selected_car !== "2011" && selected_car !== "2013") {
                impact_of_extender *= 2;
            }
            fullspeed_estimate = (100 - configs['Car model'][selected_car].fullspeed ) * impact_of_extender + configs['Car model'][selected_car].fullspeed;

        } else {
            fullspeed_estimate = (100 - configs['Main battery upgrade'][selected_main].fullspeed)*impact_of_extender + configs['Main battery upgrade'][selected_main].fullspeed;
        }
    }

    function updateStats(){
        document.getElementById('stats_cost').innerHTML = "&euro;" + cost.toFixed(0);
        document.getElementById('stats_capacity').innerText = usable_capacity.toFixed(1) + "kWh";
        document.getElementById('stats_range').innerText = range.toFixed(0) + "km";
        document.getElementById('stats_chargingspeed').innerHTML = "0-" + fullspeed_estimate.toFixed(0) + "% (" + (fullspeed_estimate * usable_capacity / 100).toFixed(1) + " kWh)";
    }

    function updateCar() {
        //  Hide all cars
        document.querySelectorAll("svg").forEach(function (elem) { elem.style.opacity = 0  });

        // Show selected car
        document.getElementById("svg-"+selected_car).style.opacity = 1;

        // Hide all extensions
        document.querySelectorAll("[id*='upgrade']").forEach(function (elem) { elem.style.opacity = 0  });

        // Show selected extension
        if (selected_extender !== "None"){
            console.log("Ext!");
            if (selected_extender === "8.8 kWh") document.getElementById(selected_car + "-upgrade-" +  "8-8").style.opacity = 1;
            if (selected_extender === "17.6 kWh") document.getElementById(selected_car + "-upgrade-" +  "17-6").style.opacity = 1;
        }
        console.log(selected_extender);


    }

    // Utility functions to help manipulate the DOM
    function addElement(target, tag, attrs){
        var newElement = document.createElement(tag);

        for(var attr in attrs){
            if(attrs.hasOwnProperty(attr)) newElement.setAttribute(attr, attrs[attr]);
        }

        target.appendChild(newElement);

        return newElement;
    }

    function id(id){
        return document.getElementById(id);
    }

    function setText(target, text){
        var newContent = document.createTextNode(text);
        target.appendChild(newContent);
        return target;
    }

    function strToAttribute(text){
        return text.replace(/\W/g,'-').toLowerCase();
    }

    /**
     * Loads a SVG file from the 'assets' folder inline into a target DOM-object
     * @param target DOM-object where the SVG will be appended to
     * @param filename
     */
    function loadSVG(target, filename){
        xhr = new XMLHttpRequest();
        xhr.open("GET","./assets/" + filename + ".svg",false);

        xhr.overrideMimeType("image/svg+xml");
        xhr.send("");
        target.appendChild(xhr.responseXML.documentElement);
    }

</script>


</body>
</html>